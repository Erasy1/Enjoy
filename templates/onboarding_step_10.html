<!doctype html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Onboarding - Q10</title>

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700;800&display=swap" rel="stylesheet">

  <style>
    :root{
      --card: rgba(240,240,240,.82);
      --accent: #9c27b0;
      --accent-dark: #7b1fa2;
      --pink: #e91e63;
      --back: #3f53ff;
      --back-hover: #3446d9;
      --next: #1f1fb8;
      --next-hover: #18189a;
      --text: #1b1b1b;
      --muted: rgba(0,0,0,.55);
      --line: rgba(0,0,0,.14);
      --white: rgba(255,255,255,.92);
    }
    *{ box-sizing:border-box; }
    html, body{ height:100%; }
    body{
      margin:0;
      font-family:Poppins, system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      color:var(--text);
    }

    .page{
      min-height:100vh;
      display:grid;
      place-items:center;
      padding:24px;
      background: url("{{ url_for('static', filename='welcome.jpg') }}") center/cover no-repeat;
      position:relative;
      overflow:hidden;
    }
    .page::before{ content:""; position:absolute; inset:0; background: rgba(0,0,0,.25); }

    .card{
      position:relative;
      width:min(920px, 94vw);
      border-radius:22px;
      background: var(--card);
      box-shadow: 0 24px 80px rgba(0,0,0,.45);
      padding: 26px 28px 20px;
    }

    .top{ display:grid; justify-items:center; gap:10px; margin-bottom:14px; }
    .qcount{ font-weight:700; font-size:20px; color: rgba(0,0,0,.75); }

    .progress{
      width:min(420px, 75%);
      height:10px;
      border-radius:999px;
      background: rgba(0,0,0,.12);
      position:relative;
      overflow:hidden;
    }
    .progress > span{
      position:absolute; left:0; top:0; bottom:0;
      width: 100%;
      background: var(--pink);
      border-radius:999px;
    }

    .question{
      text-align:center;
      font-size: clamp(18px, 2.4vw, 24px);
      font-weight:700;
      margin: 6px 0 10px;
      color: rgba(0,0,0,.75);
    }

    .flash{
      width: min(650px, 96%);
      margin: 0 auto 10px;
      padding: 10px 12px;
      border-radius: 14px;
      background: rgba(255,255,255,.92);
      box-shadow: 0 12px 26px rgba(0,0,0,.15);
      font-weight: 800;
      text-align: center;
    }

    .searchbar{
      display:flex;
      align-items:center;
      gap:10px;
      width:min(560px, 96%);
      margin: 0 auto 12px;
    }
    .searchwrap{ position:relative; flex:1; }
    .icon{
      position:absolute;
      left:14px; top:50%;
      transform: translateY(-50%);
      color: var(--muted);
      font-weight:900;
      user-select:none;
    }
    .search{
      width:100%;
      height:40px;
      border-radius:999px;
      border: 2px solid rgba(0,0,0,.18);
      padding: 0 14px 0 38px;
      outline:none;
      background:#fff;
      font-weight:700;
    }
    .search:focus{
      border-color: rgba(156,39,176,.55);
      box-shadow: 0 0 0 4px rgba(156,39,176,.15);
    }

    .btn-plus{
      width:44px;
      height:40px;
      border:0;
      border-radius:10px;
      background: var(--accent);
      color:#fff;
      font-size:22px;
      font-weight:900;
      cursor:pointer;
      display:inline-flex;
      align-items:center;
      justify-content:center;
      box-shadow: 0 14px 28px rgba(123,31,162,.20);
    }

    .list{
      width:min(650px, 96%);
      margin: 0 auto 8px;
      border-radius:14px;
      overflow:hidden;
      background: rgba(255,255,255,.65);
      border: 1px solid rgba(0,0,0,.10);
    }

    .row{
      display:grid;
      grid-template-columns: 44px 1fr 44px;
      align-items:center;
      gap:10px;
      padding: 8px 10px;
      border-bottom: 1px solid var(--line);
    }
    .row:last-child{ border-bottom:0; }

    .poster{
      width:34px; height:34px;
      border-radius:8px;
      background: rgba(0,0,0,.10);
      overflow:hidden;
    }
    .poster img{ width:100%; height:100%; object-fit:cover; display:block; }

    .title{
      font-weight:800;
      color: rgba(0,0,0,.78);
      font-size:14px;
      line-height: 1.2;
    }
    .meta{
      font-size:12px;
      color: var(--muted);
      font-weight:800;
      margin-top: 2px;
    }

    .add{
      width:34px; height:34px;
      border:0;
      border-radius:10px;
      background: var(--accent);
      color:#fff;
      cursor:pointer;
      font-size:18px;
      font-weight:900;
      display:inline-flex;
      align-items:center;
      justify-content:center;
    }
    .add[disabled]{
      opacity:.45;
      cursor:not-allowed;
    }

    .selectedBar{
      width:min(650px, 96%);
      margin: 6px auto 0;
      display:flex;
      align-items:center;
      gap:10px;
      flex-wrap:wrap;
    }
    .selectedCount{
      font-weight:900;
      color: rgba(52, 108, 255, 0.95);
      margin-right: 6px;
    }

    .pill{
      display:inline-flex;
      align-items:center;
      gap:8px;
      height:26px;
      padding: 0 10px;
      border-radius: 999px;
      background: rgba(255,255,255,.9);
      border: 1px solid rgba(0,0,0,.12);
      font-size:12px;
      font-weight:900;
      color: rgba(0,0,0,.70);
      max-width: 220px;
      overflow:hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }
    .pill button{
      width:18px; height:18px;
      border:0;
      border-radius:6px;
      background: rgba(0,0,0,.15);
      cursor:pointer;
      font-weight:900;
      line-height: 18px;
      flex: 0 0 auto;
    }

    .footer{
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:18px;
      margin-top: 14px;
    }

    .btn{
      min-width:140px;
      height:44px;
      border:0;
      border-radius:999px;
      color: rgba(255,255,255,.92);
      font-weight:900;
      cursor:pointer;
      transition: transform .15s ease, background .15s ease, opacity .15s ease;
    }
    .btn:hover{ transform: translateY(-1px); }

    .btn-back{
      background: var(--back);
      text-decoration:none;
      display:inline-flex;
      align-items:center;
      justify-content:center;
    }
    .btn-back:hover{ background: var(--back-hover); }

    .btn-next{ background: var(--next); }
    .btn-next:hover{ background: var(--next-hover); }

    .btn-next:disabled{
      opacity:.45;
      cursor:not-allowed;
      transform:none;
    }

    .skipLink{
      text-align:center;
      font-weight:900;
      color: rgba(124, 0, 255, 0.85);
      text-decoration:none;
      display:block;
      margin-top: 8px;
    }

    @media (max-width: 520px){
      .card{ padding: 20px 16px 16px; }
      .footer{ flex-direction:column; }
      .btn, .btn-back, .btn-next{ width:100%; }
    }
  </style>
</head>

<body>
  <main class="page">
    <section class="card" aria-label="Onboarding question 10">
      <div class="top">
        <div class="qcount">Question 10 of 10</div>
        <div class="progress" aria-label="Progress"><span></span></div>
      </div>

      <div class="question">Select at least 5 titles you liked</div>

      {% with messages = get_flashed_messages() %}
        {% if messages %}
          <div class="flash">{{ messages[0] }}</div>
        {% endif %}
      {% endwith %}

      <div class="searchbar">
        <div class="searchwrap">
          <span class="icon">üîç</span>
          <input id="q" class="search" type="text" placeholder="Search movie/series" autocomplete="off" />
        </div>
        <button id="searchBtn" class="btn-plus" type="button" title="Search">+</button>
      </div>

      <div id="list" class="list" aria-label="Search results"></div>

      <div class="selectedBar">
        <span id="count" class="selectedCount">Selected: 0/5</span>
        <div id="pills" style="display:flex; gap:10px; flex-wrap:wrap;"></div>
      </div>

      <form id="finishForm" method="post" action="{{ url_for('onboarding_step', step=10) }}">
        <div class="footer">
          <a class="btn btn-back" href="{{ url_for('onboarding_step', step=9) }}">Back</a>
          <button id="finishBtn" class="btn btn-next" type="submit" disabled>Finish</button>
        </div>

        <a class="skipLink" href="{{ url_for('dashboard') }}">Skip</a>
      </form>
    </section>
  </main>

  <script>
    const qEl = document.getElementById('q');
    const listEl = document.getElementById('list');
    const pillsEl = document.getElementById('pills');
    const countEl = document.getElementById('count');
    const finishBtn = document.getElementById('finishBtn');
    const searchBtn = document.getElementById('searchBtn');

    let liked = [];

    function escapeHtml(s){
      return (s||'').replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;');
    }

    function updateUI(){
      const n = liked.length;
      countEl.textContent = `Selected: ${n}/5`;
      finishBtn.disabled = n < 5;

      pillsEl.innerHTML = liked.map(it => `
        <span class="pill" title="${escapeHtml(it.title)}">
          ${escapeHtml(it.title)}
          <button type="button" data-del="${it.tmdb_id}">√ó</button>
        </span>
      `).join('');

      pillsEl.querySelectorAll('button[data-del]').forEach(btn => {
        btn.addEventListener('click', async () => {
          const tmdbId = btn.getAttribute('data-del');
          await fetch(`/api/onboarding/title/${tmdbId}`, { method: 'DELETE' });
          await loadSelected();
        });
      });
    }

    async function loadSelected(){
      const r = await fetch('/api/onboarding/titles');
      const data = await r.json();
      const items = Array.isArray(data.items) ? data.items : [];

      liked = items
        .filter(x => Number(x.liked) === 1)
        .map(x => ({ tmdb_id: x.tmdb_id, media_type: x.media_type, title: x.title }));

      updateUI();
    }

    function renderResults(results){
      if(!results || results.length === 0){
        listEl.innerHTML = `<div class="row"><div></div><div class="title">No results</div><div></div></div>`;
        return;
      }

      const likedSet = new Set(liked.map(x => String(x.tmdb_id)));

      listEl.innerHTML = results.slice(0, 6).map(it => {
        const t = (it.year ? `${it.title} (${it.year})` : it.title);
        const disabled = likedSet.has(String(it.tmdb_id));
        const poster = it.poster_url
          ? `<img src="${it.poster_url}" alt="">`
          : '';
        return `
          <div class="row">
            <div class="poster">${poster}</div>
            <div>
              <div class="title">${escapeHtml(t)}</div>
              <div class="meta">${escapeHtml(it.media_type)}</div>
            </div>
            <button class="add" type="button"
              data-id="${it.tmdb_id}"
              data-type="${it.media_type}"
              data-title="${escapeHtml(it.title)}"
              ${disabled ? 'disabled' : ''}>+</button>
          </div>
        `;
      }).join('');

      listEl.querySelectorAll('button.add').forEach(btn => {
        btn.addEventListener('click', async () => {
          const tmdb_id = Number(btn.getAttribute('data-id'));
          const media_type = btn.getAttribute('data-type') || 'movie';
          const title = btn.getAttribute('data-title') || `tmdb:${tmdb_id}`;

          await fetch('/api/onboarding/title', {
            method: 'POST',
            headers: {'Content-Type':'application/json'},
            body: JSON.stringify({ tmdb_id, media_type, title, liked: true })
          });

          await loadSelected();
          btn.disabled = true;
        });
      });
    }

    async function doSearch(){
      const q = (qEl.value || '').trim();
      if(q.length < 2){
        listEl.innerHTML = `<div class="row"><div></div><div class="title">Type at least 2 characters</div><div></div></div>`;
        return;
      }

      const r = await fetch(`/api/tmdb/search?q=${encodeURIComponent(q)}&lang=en-US`);
      const data = await r.json();
      renderResults(data.results || []);
    }

    qEl.addEventListener('keydown', (e) => {
      if(e.key === 'Enter'){
        e.preventDefault();
        doSearch();
      }
    });

    searchBtn.addEventListener('click', doSearch);

    loadSelected();
    listEl.innerHTML = `<div class="row"><div></div><div class="title">Search and add titles you like</div><div></div></div>`;
  </script>
</body>
</html>

