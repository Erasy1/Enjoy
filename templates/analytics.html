<!doctype html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>ENJOY â€” Analytics</title>

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Pontano+Sans&display=swap" rel="stylesheet">

  <!-- ÑÑ‚Ğ¸Ğ»ÑŒ ĞºĞ°Ğº Home -->
  <link rel="stylesheet" href="{{ url_for('static', filename='dashboard.css') }}">
  <!-- Ğ»Ğ¾ĞºĞ°Ğ»ÑŒĞ½Ñ‹Ğµ ÑÑ‚Ğ¸Ğ»Ğ¸ analytics -->
  <link rel="stylesheet" href="{{ url_for('static', filename='analytics_dash.css') }}">

  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>

<body>
  <div class="layout">
    <!-- SIDEBAR -->
    <aside class="sidebar" id="sidebar" aria-label="Sidebar">
      <div class="brandRow">
        <div class="brandBadge" aria-hidden="true">
          <span class="brandBadgeText">Ej</span>
        </div>
      </div>

      <nav class="nav" aria-label="Main navigation">
        <a class="navItem {{ 'active' if active_page=='home' else '' }}" href="{{ url_for('dashboard') }}">
          <span class="navIcon">ğŸ </span><span class="navLabel">Home</span>
        </a>

        <a class="navItem {{ 'active' if active_page=='movies' else '' }}" href="{{ url_for('movies_page') }}">
          <span class="navIcon">ğŸ¬</span><span class="navLabel">Movies</span>
        </a>

        <a class="navItem {{ 'active' if active_page=='series' else '' }}" href="{{ url_for('series_page') }}">
          <span class="navIcon">ğŸ“º</span><span class="navLabel">Series</span>
        </a>

        <a class="navItem {{ 'active' if active_page=='my_list' else '' }}" href="{{ url_for('my_list_page') }}">
          <span class="navIcon">ğŸ§¾</span><span class="navLabel">My list</span>
        </a>

        <a class="navItem {{ 'active' if active_page=='analytics' else '' }}" href="{{ url_for('analytics') }}">
          <span class="navIcon">ğŸ“Š</span><span class="navLabel">Analytics</span>
        </a>

        <a class="navItem {{ 'active' if active_page=='assistant' else '' }}" href="{{ url_for('assistant_page_v2') }}">
          <span class="navIcon">ğŸ¤–</span><span class="navLabel">AI Assistant</span>
        </a>

        <div class="navDivider"></div>
      </nav>

      <div class="sideBottom">
        <a class="navItem {{ 'active' if active_page=='account' else '' }}" href="{{ url_for('settings_page') }}">
          <span class="navIcon">ğŸ‘¤</span><span class="navLabel">Account</span>
        </a>

        <a class="sideBtn logout" href="{{ url_for('logout') }}">
          â‹ <span class="navLabel">Logout</span>
        </a>
      </div>
    </aside>

    <!-- MAIN -->
    <main class="main">
      <!-- TOPBAR -->
      <header class="topbar">
        <button class="sidebarToggle" id="sidebarToggle" type="button" aria-label="Toggle sidebar" title="Toggle sidebar">
          <span></span><span></span>
        </button>

        <div class="topActions">
          <button class="topIcon" id="btnSearch" type="button" aria-label="Search" title="Search">ğŸ”</button>
          <button class="topIcon" id="btnNotif" type="button" aria-label="Notifications" title="Notifications">ğŸ””</button>

          <button class="profile" id="btnProfile" type="button" aria-label="Profile" title="Profile">
            <span class="avatar">ğŸ‘¤</span>
            <span class="nick">{{ nickname }}</span>
          </button>
        </div>
      </header>

      <!-- CONTENT -->
      <section class="anWrap">
        <div class="anHeader">
          <div class="anTitle">Analytics</div>
          <div class="anSub">History of views and preferences</div>
        </div>

        <section class="anCards">
          <div class="anCard">
            <div class="anCardTitle">Viewed</div>
            <div class="anCardValue">{{ total_titles }}</div>
            <div class="anCardHint">titles</div>
          </div>

          <div class="anCard">
            <div class="anCardTitle">Favorite genre</div>
            <div class="anCardValue">{{ favorite_genre }}</div>
            <div class="anCardHint">by view_history</div>
          </div>

          <div class="anCard">
            <div class="anCardTitle">Top genres count</div>
            <div class="anCardValue">{{ genre_labels|length }}</div>
            <div class="anCardHint">in chart</div>
          </div>
        </section>

        <section class="anGrid">
          <div class="anPanel">
            <div class="anPanelTitle">Genres (top)</div>

            <!-- Ğ’ĞĞ–ĞĞ: ĞºĞ¾Ğ½Ñ‚ĞµĞ¹Ğ½ĞµÑ€ Ğ¾Ğ³Ñ€Ğ°Ğ½Ğ¸Ñ‡Ğ¸Ğ²Ğ°ĞµÑ‚ Ñ€Ğ°Ğ·Ğ¼ĞµÑ€ Ğ³Ñ€Ğ°Ñ„Ğ¸ĞºĞ° -->
            <div class="anChartBox">
              <canvas id="genreChart"></canvas>
            </div>
          </div>
        </section>
      </section>
    </main>
  </div>

  <!-- ====== MODALS for topbar ====== -->
  <div class="modal" id="searchModal" aria-hidden="true">
    <div class="modalBackdrop" id="searchBackdrop"></div>

    <div class="modalDialog" role="dialog" aria-modal="true" aria-labelledby="searchTitle">
      <button class="modalClose" id="searchClose" type="button" aria-label="Close">âœ•</button>

      <div class="modalBody" style="grid-template-columns: 1fr; gap:12px;">
        <div class="modalTitle" id="searchTitle">Search</div>

        <input id="searchInput" class="searchInput" type="text"
               placeholder="Type movie or series..." autocomplete="off" />

        <div class="trackWrap">
          <div class="track" id="searchResults"></div>
        </div>
      </div>
    </div>
  </div>

  <div class="profileMenu" id="profileMenu">
    <a href="{{ url_for('settings_page') }}" class="profileMenuItem">ğŸ‘¤ Account</a>
    <div class="profileMenuDivider"></div>
    <a href="{{ url_for('logout') }}" class="profileMenuItem danger">â‹ Logout</a>
  </div>

  <div class="modal" id="notifModal" aria-hidden="true">
    <div class="modalBackdrop" id="notifBackdrop"></div>

    <div class="modalDialog" role="dialog" aria-modal="true" aria-labelledby="notifTitle">
      <button class="modalClose" id="notifClose" type="button" aria-label="Close">âœ•</button>

      <div class="modalBody" style="grid-template-columns: 1fr;">
        <div class="modalTitle" id="notifTitle">Notifications</div>
        <div class="notifList" id="notifList">
          <div class="notifItem">No notifications yet</div>
        </div>
      </div>
    </div>
  </div>

  <!-- Ğ¾Ğ±Ñ‰Ğ¸Ğ¹ JS (sidebar/topbar/search/notif/profile) -->
  <script src="{{ url_for('static', filename='dashboard.js') }}"></script>

  <!-- Chart init -->
  <script>
    const genreLabels = {{ genre_labels|tojson }};
    const genreValues = {{ genre_values|tojson }};

    const canvas = document.getElementById("genreChart");
    if (canvas && Array.isArray(genreLabels) && genreLabels.length) {
      new Chart(canvas, {
        type: "doughnut",
        data: {
          labels: genreLabels,
          datasets: [{ data: genreValues }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false, // ĞºĞ»ÑÑ‡ĞµĞ²Ğ¾Ğµ â€” Ñ‡Ñ‚Ğ¾Ğ±Ñ‹ Ğ³Ñ€Ğ°Ñ„Ğ¸Ğº Ğ½Ğµ Ñ€Ğ°Ğ·Ğ´ÑƒĞ²Ğ°Ğ»ÑÑ
          plugins: { legend: { position: "bottom" } },
          cutout: "62%"
        }
      });
    }
  </script>
</body>
</html>

